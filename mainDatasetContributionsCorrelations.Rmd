---
title: "Analyses of main simulation dataset - Contributions and correlations"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

```{r, echo=F, message=F, warning=F}
options(stringsAsFactors = F, scipen = 20)
library(data.table)
library(ggplot2)
library(cowplot)
library(R.matlab)
library(RColorBrewer)
library(mimosa)
library(Rcpp)
library(grid)

homedir = "~/Documents/GS_server/PROJECTS/MORE_METABOLOMICS_CN/"
datadir = paste0(homedir, "RESULTS/AGORA/")
source("FBA_functions.R")

#Data Files
media_file = "FaithMedia_AGORA_F_final.csv"
dictionary_file = "Dictionary_AGORA_complete.csv"
met_key_file = "hmdb_brite_metabolite_classes.txt"
spec_file = "allSpeciesFinalMain.txt"
met_file = "allMetabolitesFinalMain.txt"
spec_example_file = "allSpeciesExampleRun.txt"
flux_example_file = "exampleAcetateFluxes.txt"
all_fluxes_file = "allMetFluxesFinalMain.txt"

##Reference information: Media, species IDs & categories, metabolite IDs & categories
media = fread(media_file)
media[,V1:=gsub("[e]", "[env]", V1, fixed = T)]
setnames(media, "V1", "medium")

spec_codes = make_spec_codes()

dictionary = fread(dictionary_file)
dictionary[,medium:=gsub("[e]", "[env]", medium, fixed = T)]
dictionary[Primary=='L-lysinium(1+)', Primary:="L-lysine"]
dictionary[,Primary:=gsub(" \\(.*\\)$","", Primary)]
dictionary[,Primary:=gsub("\\(.*\\)$","", Primary)]
dictionary[Primary=='L-argininium', Primary:="L-arginine"]
dictionary[Primary=="proton", Primary:="H+"]
dictionary[Primary=="hydrogenphosphate", Primary:="Orthophosphate"]
dictionary[grepl("Amylopectin", Primary), Primary:="Amylopectin"]
setnames(dictionary, "Primary", "Metabolite")
kegg_translate = dictionary[,list(Metabolite, medium)]
#dictionary_sub = dictionary[medium %in% all_mets[,unique(medium)]]
dictionary[,niceLab:=tolower(Metabolite)]

path_key = fread(met_key_file)
path_key = merge(path_key, dictionary[,list(niceLab, medium)], by = "niceLab", all = T)
path_key[,Metabolite:=NULL]

##Color scale for plotting species
getPalette = colorRampPalette(brewer.pal(9, "Set1"))
col_spec = c(getPalette(10), "grey50", "grey20")
names(col_spec) = c(spec_codes[1:10][order(SpeciesName), Code], "in", "out")
col_spec2 = col_spec
names(col_spec2) = c(spec_codes[1:10][order(SpeciesName), SpeciesName], "Inflow", "Outflow")

timePointFinal = 577

```

Species abundance data:

```{r, echo=F, message=F, warning=F}
# all_species = fread("allSpeciesMain.txt")
# all_species[,Sample:=paste0("run", SimRun, "_", paste0(spec_codes[,Code], collapse=""), "_TP", TimePoint)]
# all_species = merge(all_species, spec_codes, by = c("Species", "Code"), all.x=T, all.y=F)
# 
# #How many reach steady state?
# #define as abundance change < 1% of capacity (0.433/100) over last 12 time points (3 hours)
# all_species[,TimePoint0:=TimePoint-1]
# perc_change = merge(all_species[,list(SimRun, Species,TimePoint,value)], all_species[,list(SimRun,Species,TimePoint0,value)], by.x = c("SimRun","Species","TimePoint"), by.y = c("SimRun", "Species","TimePoint0"))
# perc_change[,percChange:=(value.x-value.y)/value.x]
# perc_change[,absChange:=value.x-value.y]
# perc_change = perc_change[TimePoint >= (timePointFinal-12)]
# perc_change[,max(abs(absChange)), by=list(Species, SimRun)][,max(V1), by=SimRun][,table(V1 < 0.433/10000)]

#fake_spec = all_species[TimePoint==timePointFinal]
fake_spec = fread(spec_file)
fake_spec[,SampleID:=SimRun]
fake_spec = merge(fake_spec, spec_codes, by = c("Species", "Code"))
fake_spec[,SpeciesName:=factor(SpeciesName, levels = rev(spec_codes[,SpeciesName]))] 

fake_spec[,axisLabel:=factor(ifelse(SimRun==3, "*", SimRun), levels = c(1:2, "*", 4:max(SimRun)))]
fake_spec[,SpeciesName2:=paste0(SpeciesName, " (", Code, ")")]
fake_spec[,SpeciesName2:=factor(SpeciesName2, levels = c(rev(spec_codes[1:10,paste0(SpeciesName, " (", Code, ")")])))]
col_spec4 = col_spec2
names(col_spec4)[1:10] = fake_spec[,sort(levels(SpeciesName2))]
spec_plot = ggplot(fake_spec, aes(x=factor(axisLabel), y = value, fill = SpeciesName2)) + geom_bar(position = "fill", stat = "identity") + scale_fill_manual(values = col_spec4) + theme_classic() + scale_y_continuous(expand=c(0,0)) + theme(axis.ticks = element_blank(), legend.title = element_blank(), legend.text = element_text(face="italic", size=11.5), axis.title = element_text(size=15), axis.text.y = element_text(size=13),axis.text.x = element_text(face = "bold", size = 15), panel.spacing = margin(0, "inches"), plot.margin = margin(0.3, 0.08, 0.1, 1.7, "inches")) + xlab("") + ylab("Species relative abundance") + scale_size_manual(values = c(0,1)) + guides(col = F, size = F) + scale_x_discrete(breaks = c("*"))

spec_plot = plot_grid(spec_plot, labels = c("Sample"), label_x=0.385, label_y=0.163, label_fontface = "plain")

example_dat = fread(spec_example_file)
example_dat[,Time:=TimePoint/4]
example_dat = merge(example_dat, spec_codes, by = c("Species", "Code"))
spec_example_plot = ggplot(example_dat[(TimePoint-1) %% 8==0], aes(x=Time, y = value, col=SpeciesName, size = TimePoint==timePointFinal)) + geom_point() + facet_wrap(~SimRun) + scale_color_manual(values=col_spec2) + scale_size_manual(values = c(0.9, 2.25)) + theme(legend.title = element_blank(), legend.text = element_text(face="italic"), strip.background = element_blank(), strip.text = element_blank(), axis.ticks = element_blank(), axis.text = element_text(size=14), axis.title = element_text(size=14), axis.line = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.background = element_blank(), panel.background = element_blank(), panel.border = element_rect(fill=NA, color = "black", size = 1, linetype="solid")) + ylab("Species absolute abundance") + scale_x_continuous(breaks = c(0,24, 48,72, 96, 120), expand = c(0.02,0, 0.1, 0)) + scale_y_continuous(expand = c(0.02,0, 0.1, 0)) + xlab("Time (hours)") + guides(size = F, col = F)

```


Metabolite concentration data:

```{r, echo=F, message=F, warning=F}

fake_mets_melt = fread(met_file)
fake_mets_melt = merge(fake_mets_melt, path_key, by.x = c("compound", "niceLab"), by.y = c("medium", "niceLab"), all.x=T)
fake_mets_melt[,Sample:=paste0("run", SimRun, "_", paste0(spec_codes[,Code], collapse=""), "_TP", TimePoint)]
fake_mets_melt[,Run:=gsub("_.*", "", Sample)]
fake_mets_melt[,Run:=as.numeric(gsub("run", "", Run))]

met_list = fake_mets_melt[,unique(niceLab)]
met_order = fake_mets_melt[,var(value), by=niceLab][order(V1, decreasing=T), as.character(niceLab)]
fake_mets_melt[,niceLab:=factor(niceLab, levels = met_order)]

```


Example plot of fluxes
```{r, echo=F, message=F, warning=F}
#Very large file
# load(paste0(datadir, "TenSpecVary_relAbund_chemostat_fixRevRxns_mod2media.rda"))
# ac_media = mod2media[Metabolite=="ac[env]"]
# rm(mod2media)
# load(paste0(datadir, "TenSpecVary_relAbund_chemostat_fixRevRxns_growthRates.rda"))
# setnames(ac_media, "Metabolite", "medium")
# ac_media = merge(ac_media, kegg_translate, by = "medium", all.x = T)
# ac_fluxes = getCorrectTotalFluxes(ac_media, all_mets[Metabolite=="acetate"], media, all_species, growthRates, disperse_outflow = F, max_tp = timePointFinal)
# ac_fluxes = merge(ac_fluxes, spec_codes, by="Species", all.x=T)
# write.table(ac_fluxes[,list(SimRun, TimePoint, Metabolite, medium, Species, Code, totFlux, cumulFlux)], file = "exampleAcetateFluxes.txt", quote=F, row.names=F, sep = "\t")
# ac_fluxes = fread("exampleAcetateFluxes.txt")
# ac_fluxes = merge(ac_fluxes, spec_codes, by = c("Species", "Code"))
# ac_fluxes = merge(ac_fluxes, path_key, by = "medium", all.x=T)
# ac_conc = all_mets[medium=="ac[env]"]
# ac_conc[,Species:="Concentration"]
# ac_conc[,SpeciesName:="Concentration"]
# ac_conc[,cumulFlux:=value]
# ac_conc[,totFlux:=value]
# ac_fluxes = rbind(ac_fluxes, ac_conc, fill = T)
# write.table(ac_fluxes, file = "exampleAcetateFluxes.txt")
ac_fluxes = fread(flux_example_file)
good_spec = ac_fluxes[,length(totFlux[totFlux != 0]), by=Species][V1 !=0 & Species != "Outflow", Species]
ac_fluxes[,Time:=TimePoint/4]
ac_fluxes[,type:=ifelse(Species=="Concentration", "Acetate concentration", "Acetate cumulative flux")]
ac_fluxes[,type:=factor(type, levels = c("Acetate cumulative flux","Acetate concentration"))]
ac_fluxes = merge(ac_fluxes, spec_codes, by = c("Species", "Code"), all.x=T)
ac_fluxes[type=="Acetate concentration", SpeciesName:="Concentration"]

met_flux_example_plot3 = ggplot(ac_fluxes[SimRun==3 & TimePoint <= timePointFinal & Metabolite=="acetate" & Species %in% good_spec & (TimePoint-1) %% 8==0], aes(x=Time, y = cumulFlux, col=SpeciesName, group=SpeciesName, shape = factor(ifelse(SpeciesName=="Concentration", 1, 0)), size = TimePoint==timePointFinal))  +geom_point() + facet_grid(type~., scales = "free_y", switch = "y") + theme(strip.placement = "outside", legend.title = element_blank(), legend.text = element_text(face="italic"), strip.background = element_blank(), axis.ticks = element_blank(), axis.text = element_text(size=14), axis.title = element_text(size=14), strip.text = element_text(size=14), panel.spacing.y = unit(0.2, "inches"), plot.margin = margin(0.3, 0.3, 0.3, 0, "inches"), panel.background = element_blank(), plot.background = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_blank(), panel.border = element_rect(colour = "black", fill=NA, size = 1, linetype="solid")) + ylab("") +xlab("Time (hours)") + scale_size_manual(values = c(1.2,3))+ scale_x_continuous(breaks = c(0,24, 48, 72, 96, 120), expand = c(0.03,0, 0.1, 0.1), limits = c(0, NA)) + scale_y_continuous(expand = c(0.04,0, 0.1, 0.1))  + scale_color_manual(values=c(col_spec2, "Concentration" = "black")) + guides(col = F, size = F, linetype=F, shape = F)#breaks = c(0,24, 48, 72, 96, 120) #) #+ geom_hline(yintercept=0)

fig1_examples = plot_grid(spec_example_plot+ guides(col = guide_legend(nrow = 5)) + theme(legend.position = "bottom"), met_flux_example_plot3, nrow = 1, labels = c("A", "B"))
save_plot(fig1_examples, file = "Figure1_examples.png", base_width= 10, base_height = 6)

```

Distributions of species and metabolites (Figure S1)

```{r, echo=F, message=F, warning=F}
spec_dists = ggplot(fake_spec, aes(x=value)) + geom_histogram(bins = 15) + facet_wrap(~Code, scales = "free", ncol = 5) + theme(strip.background = element_blank()) + xlab("Species abundance") + ylab("Sample count") + theme(axis.text = element_text(size=6), axis.title = element_text(size=9), strip.text = element_text(size = 9)) + scale_y_continuous(expand = c(0,0))

met_list_sub3 = c("putrescine", "tetradecanoate", "uracil", "acetate", "succinate")

fake_mets_melt[,axisLabel:=ifelse(Run==3 & niceLab=="acetate", "*", Run)]
fake_mets_melt[,axisLabel:=factor(axisLabel, levels = c(1:2, "*", 3:max(Run)))]
fake_mets_melt[,niceLab2:=niceLab]
fake_mets_melt[,niceLab2:=factor(niceLab2, levels = met_list_sub3)]
fake_mets_melt[,mediaMet:=ifelse(compound %in% media[,medium],1,0)]
fake_mets_melt[,niceLab3:=ifelse(grepl("meso-2;6", niceLab), "meso-2;6-diamino\nheptanedioate", as.character(niceLab))]

met_dists = ggplot(fake_mets_melt[compound %in% path_key[!is.na(Class2),unique(medium)]], aes(x=value)) + geom_histogram(bins=15) + facet_wrap(~niceLab3, scales = "free", ncol=5)+ theme(strip.background = element_blank()) + xlab("Metabolite concentration") + ylab("Sample count") + theme(axis.text = element_text(size=5), axis.title = element_text(size=9), strip.text = element_text(size = 8))+ scale_y_continuous(expand = c(0,0))

new_fig_s1 = plot_grid(spec_dists, met_dists, rel_heights = c(1,3.8), labels = c("A", "B"), nrow = 2)
save_plot(new_fig_s1, file = "new_fig_s1_dists.png", base_width = 7.5, base_height= 11.5)

```


Get contributions, general statistics about them

```{r, echo=F, message=F, warning=F}

all_met_fluxes_final1 = fread(all_fluxes_file)
all_met_fluxes_final1[,niceLab:=factor(niceLab, levels = met_order)]

shap_contribs1 = getContributions(all_met_fluxes_final1, spec_codes[Code != "out"], kegg_translate, path_key)
shap_contribs1[,niceLab:=factor(tolower(niceLab), levels=met_order)]


met_summary = fake_mets_melt[,list(mean(value,na.rm=T), var(value,na.rm=T), sd(value, na.rm=T)/mean(value, na.rm=T)),by=list(niceLab,compound)]
setnames(met_summary, c("V1", "V2", "V3"), c("Mean", "Variance", "CoefVar"))

var_cutoff = met_summary[Variance !=0, quantile(Variance, 0.25)*1.000001] #handle numerical issues
shap_contribs = shap_contribs1[TrueVar > var_cutoff]
shap_contribs[,niceLab:=factor(tolower(niceLab), levels=met_order)]

#Get scaled contribution values
shap_contribs[,PosVarShare:=ifelse(V1 > 0, V1/sum(V1[V1 > 0]),0), by=niceLab]
shap_contribs[,VarShareMagnitude:=abs(V1)/sum(abs(V1)), by=niceLab]

shap_contribs = merge(shap_contribs, path_key, by.x = c("niceLab", "compound"), by.y = c("niceLab", "medium"), all.x=T)

all_met_fluxes_final = all_met_fluxes_final1[niceLab %in% shap_contribs[,unique(niceLab)]]

shap_contribs[,mediaMet:=ifelse(compound %in% media[,medium], 1, 0)]
shap_contribs = merge(shap_contribs, met_summary, by = c("compound","niceLab"), all.x=T, all.y=F)

mean_flux= all_met_fluxes_final1[,list(mean(cumulFlux), var(cumulFlux)), by=list(niceLab,Species)]
setnames(mean_flux, c("V1","V2"), c("meanFlux", "varFlux"))
shap_contribs = merge(shap_contribs, mean_flux, by = c("niceLab", 'Species'), all.x=T, all.y=F)

all_met_fluxes_final = merge(all_met_fluxes_final, spec_codes, by = "Species")
rxn_pairs = all_met_fluxes_final[Code != "in" & niceLab %in% path_key[,niceLab],list(length(unique(Species[cumulFlux >0])), length(unique(Species[cumulFlux <0]))), by=niceLab]
rxn_pairs[,Synth:=ifelse(V1 > 0,1,0)]
rxn_pairs[,Deg:=ifelse(V2 > 0,1,0)]
rxn_pairs[,sum(Synth) > 0 & sum(Deg) > 0, by=niceLab][V1==T] 
rxn_pairs[,mediaMet:=ifelse(niceLab %in% shap_contribs[mediaMet==1, unique(niceLab)], 1, 0)]
rxn_pairs[,table(Synth, Deg, mediaMet)]
rxn_pairs[mediaMet==1 & Synth==1 & Deg==0] #weird
rxn_pairs[,table(Synth,Deg)]

rxn_pairs_spec = all_met_fluxes_final[Code != "in" & niceLab %in% shap_contribs[,unique(niceLab)], list(length(unique(SimRun[cumulFlux > 0])), length(unique(SimRun[cumulFlux < 0]))), by=list(niceLab, SpeciesName)]
setnames(rxn_pairs_spec, c("V1", "V2"), c("SynthSamples", "DegSamples"))

shap_contribs = merge(shap_contribs, rxn_pairs_spec, by = c("niceLab", "SpeciesName"), all.x=T, all.y=F)

#Do negative contributions arise via cross-feeding or competition?
shap_contribs[Code.x != "in",list(sum(V1 < 0), sum(SynthSamples > 0), sum(DegSamples > 0)), by=list(niceLab, mediaMet)][V1 > 0,table(V2 > 0 & V3 > 0, mediaMet)]
shap_contribs[Code.x != "in",list(sum(V1 < 0), sum(SynthSamples > 0), sum(DegSamples > 0)), by=list(niceLab, mediaMet)][,table(V1 > 0, V2 > 0 & V3 > 0, mediaMet)]

shap_contribs[,sum(V1 < 0), by=list(niceLab, mediaMet)][,table(mediaMet, V1 > 0)]
shap_contribs[,sum(V1 < 0), by=list(niceLab, mediaMet)][,median(V1), by=mediaMet]

#Do species with the highest average flux have the highest contribution?
shap_contribs[Code.x != "in",cor(abs(meanFlux), abs(VarShare), method="spearman"), by=niceLab][,summary(V1)]
shap_contribs[Code.x != "in",cor.test(abs(meanFlux), abs(VarShare), method="spearman")$p.value, by=niceLab][,table(V1 < 0.01)]
shap_contribs[Code.x != "in",cor.test(abs(meanFlux), abs(VarShare), method="spearman")$estimate, by=niceLab][,mean(V1)]
shap_contribs[Code.x != "in",cor.test(abs(meanFlux), abs(VarShare), method="spearman")$estimate, by=niceLab][,median(V1)]

```


Figure 2: Combination metabolites/fluxes/contributions plot

```{r, echo=F, message=F, warning=F}
all_met_fluxes_final[,mediaMet:=ifelse(compound %in% media[,medium],1,0)]
fake_mets_melt[,SpeciesName:="Concentration"]
fake_mets_melt[,cumulFlux:=value]
fake_mets_melt[,SimRun:=as.numeric(gsub("run", "", gsub("_Er.*", "",Sample)))]
all_met_fluxes_final_plot = rbind(all_met_fluxes_final, fake_mets_melt, fill = T)

col_spec3 = c(col_spec2, Concentration = "black")

all_met_fluxes_final_plot = all_met_fluxes_final_plot[niceLab %in% shap_contribs[,unique(niceLab)]]
all_met_fluxes_final_plot[,SpeciesName:=factor(SpeciesName, levels = c(spec_codes[,SpeciesName], "Concentration"))]
all_met_fluxes_final_plot[is.na(SpeciesName), SpeciesName:=SpeciesName.x]
all_met_fluxes_final_plot[,type:=ifelse(SpeciesName %in% c("Concentration", "Inflow"), paste0(niceLab, " concentration"), paste0(niceLab, " fluxes"))]
all_met_fluxes_final_plot[,type2:=ifelse(SpeciesName %in% c("Concentration", "Inflow"), "Concentration", "Fluxes")]

sub_fluxes_plot = all_met_fluxes_final_plot[niceLab %in% met_list_sub3]
sub_fluxes_plot[,niceLab:=factor(niceLab, levels = met_list_sub3)]
sub_fluxes_plot = sub_fluxes_plot[cumulFlux!=0]
sub_fluxes_plot[,type2:=factor(type2, levels = c("Fluxes", "Concentration"))]
type_order = c(sapply(met_list_sub3, function(x){ return(c(paste0(x, " concentration"), paste0(x, " fluxes")))}))
sub_fluxes_plot[,type:=factor(type, levels = c(type_order))]
met_plot = ggplot(sub_fluxes_plot[SpeciesName != "Inflow"], aes(x=SimRun, y = cumulFlux, col = SpeciesName, shape = type2)) + geom_point(size=0.9)  + facet_wrap(~type, scales = "free", strip.position = "left", nrow = 10) + theme(strip.text = element_blank(),strip.placement = "outside", axis.title.y = element_blank(),axis.text.x = element_blank(),axis.text.y = element_text(size=8), strip.background = element_blank(),  axis.ticks = element_blank(), legend.title = element_blank(), panel.spacing = unit(0.2, "inches"), plot.margin = margin(0.2, 0.3, 0.2, 0.01, 'inches')) + scale_color_manual(values = col_spec3) + scale_x_continuous(expand = c(0,0))+xlab("Sample") + scale_shape_manual(values = c(17, 16))+ guides(col = F, shape = F)

met_sub_dat = shap_contribs[niceLab %in% met_list_sub3 & Code.x != "in"]
met_sub_dat[,niceLab:=factor(niceLab, levels = met_list_sub3)]

all_sub_contribs = ggplot(met_sub_dat,  aes(y=VarShare, x = SpeciesName, fill = SpeciesName)) + geom_bar(stat = "identity") + facet_wrap(~niceLab, scales = "free", nrow = 5) + scale_fill_manual(values = col_spec2) + geom_abline(intercept = 0, slope = 0, linetype = 2) + theme(strip.background = element_blank(), axis.ticks.y = element_blank(), axis.text.x = element_text(size=8), axis.text.y = element_blank(), legend.title = element_blank(), strip.text = element_blank(), axis.title.y = element_blank(), panel.spacing = unit(0.15, "inches"), plot.margin = margin(0.2, 0.4, 0.3, 0.1, "inches")) + ylab("Contribution to variance") + coord_flip()#

metfluxlist = list()
metcontribslist = list()
for(j in 1:length(met_list_sub3)){
  if(j != 5){
    metfluxlist[[j]] = make_met_plot(met_list_sub3[j], sub_fluxes_plot)
    metcontribslist[[j]] = make_contribs_plot(met_list_sub3[j], met_sub_dat)
  } else {
    metfluxlist[[j]] = make_met_plot(met_list_sub3[j], sub_fluxes_plot)+theme(axis.title.x = element_text()) + xlab("Sample") 
    metcontribslist[[j]] = make_contribs_plot(met_list_sub3[j], met_sub_dat)+theme(axis.title.x = element_text()) + ylab("Contribution to variance")
  }
}
metfluxlist[[5]] = metfluxlist[[5]] + theme(plot.margin = margin(0.15, 0.15, 0, 0.05, "inches"))
metcontribslist[[5]] = metcontribslist[[5]] + theme(plot.margin = margin(0.15, 0.5, 0, 0.27, "inches"))

label_dat = data.table(niceLab=factor(met_list_sub3, levels = met_list_sub3))
label_dat[,Inflow:=sapply(met_list_sub3, function(x){
  foo = sub_fluxes_plot[SpeciesName=="Inflow" &niceLab==x, unique(cumulFlux)]
  if(length(foo) != 0){
    return(paste0("Inflow: ", round(foo, 3)))
  } else { return("")}})]
label_dat[,Panel:=c("B", "C", "D", "E", "F")]


plot_labels = ggplot(label_dat) + geom_text(aes(label=Inflow), x=0.5, y=0.5) + geom_text(aes(label=niceLab), x= 0.5, y = 0.75, size=5)+facet_wrap(~Panel, strip.position = "top", nrow = 5) + theme_minimal()+ theme(strip.background = element_blank(), plot.margin = margin(0.01, 0.05, 0.4, 0.15, "inches"), strip.text = element_text(size = 14, hjust=1, face="bold")) + scale_x_continuous(expand = c(0,0)) + scale_y_continuous(expand = c(0,0)) #strip.text.y = element_text(angle = -180, hjust=1, size = 16)


shape_legend = g_legend(metfluxlist[[1]] + theme(legend.margin = margin(0, 1, 0.1, 2.2, "inches")) + guides(shape = guide_legend(nrow = 1, override.aes = list(size = 2))))

fig2 = plot_grid(spec_plot, plot_grid(plot_labels, plot_grid(plotlist = metfluxlist, nrow = 5, align = "v", axis = "lr", rel_heights = c(1,1,1,1,1.02)), plot_grid(plotlist = metcontribslist, nrow = 5, align = "v", axis = "lr", rel_heights = c(1,1,1,1,1.02)), nrow = 1, rel_widths = c(0.9, 3.5, 1.5)),shape_legend, nrow = 3, rel_heights = c(10,24,1), label_x = c(0.1,0.28, 0), label_y = c(0.96, 1.02,1), labels = c("A", "Fluxes/Concentrations", "")) + draw_label("Contribution profiles", x = 0.855, y = 0.716, fontface = "bold")
save_plot(fig2, file = "fig2_expanded.png", base_width = 12, base_height = 12)

shap_contribs[,niceLab:=factor(niceLab, levels = met_order)]
media_contribs = ggplot(shap_contribs[!is.na(VarShare) & mediaMet==1 & Code.x != "in"], aes(y=VarShare, x = SpeciesName, fill = SpeciesName)) + geom_bar(stat = "identity") + facet_wrap(~niceLab, scales = "free", nrow = 6) + scale_fill_manual(values = col_spec2) + geom_abline(intercept = 0, slope = 0, linetype = 2) + theme(strip.background = element_blank(), axis.ticks.y = element_blank(), axis.text.x = element_text(size=8), axis.text.y = element_blank(), legend.title = element_blank(), legend.text = element_text(face = "italic"), strip.text = element_text(size=7), legend.position = "bottom", plot.margin = margin(0.3, 0.1, 0.1, 0.1, "inches")) + ylab("Contribution to variance") + xlab("") + coord_flip()#

not_media_contribs = ggplot(shap_contribs[!is.na(VarShare) & mediaMet==0 & Code.x != "in"], aes(y=VarShare, x = SpeciesName, fill = SpeciesName)) + geom_bar(stat = "identity") + facet_wrap(~niceLab, scales = "free", nrow = 2) + scale_fill_manual(values = col_spec2) + geom_abline(intercept = 0, slope = 0, linetype = 2) + theme(strip.background = element_blank(), axis.ticks.y = element_blank(), axis.text.x = element_text(size=8), axis.text.y = element_blank(), legend.title = element_blank(), strip.text = element_text(size=7), plot.margin = margin(0.3, 0.1, 0.1, 0.1, "inches")) + ylab("Contribution to variance") + xlab("") + coord_flip()#
save_plot(plot_grid(media_contribs , not_media_contribs+ guides(fill = F), nrow=2, rel_heights=c(2.6,1), labels = c("Metabolites in nutrient inflow", "Non-inflow metabolites")), file = "FigureS4_allContribs.png", base_height=12, base_width=12)

all_met_fluxes_final_plot = rbind(all_met_fluxes_final, fake_mets_melt, fill = T)
all_met_fluxes_final_plot = all_met_fluxes_final_plot[niceLab %in% shap_contribs[,unique(niceLab)]]
all_met_fluxes_final_plot[,SpeciesName:=factor(SpeciesName, levels = c(spec_codes[,SpeciesName], "Concentration"))]
all_met_fluxes_final_plot[is.na(SpeciesName), SpeciesName:=SpeciesName.x]
all_met_fluxes_final_plot[,type2:=ifelse(SpeciesName %in% c("Inflow", "Concentration"), "Concentration", "Fluxes")]
all_met_fluxes_final_plot[is.na(Code), Code:="Concentration"]
all_met_fluxes_final_plot[,Code:=factor(Code, levels = c(spec_codes[1:11, Code], "Concentration"))]
all_met_fluxes_final_plot[,niceLab:=factor(niceLab, levels = met_order)]
media_mets = met_order[met_order %in% shap_contribs[mediaMet==1, niceLab]]
nonmedia_mets = met_order[met_order %in% shap_contribs[mediaMet==0, niceLab]]
col_spec1 = c(col_spec, "black")
names(col_spec1)[13] = "Concentration"

media_fluxes_list = lapply(media_mets, function(x){
  make_met_plot(x, all_met_fluxes_final_plot, version = "allFluxes") 
})
media_fluxes_list[[38]] = media_fluxes_list[[38]] + guides(col = guide_legend(ncol = 3), shape = guide_legend(ncol = 2)) 
for(j in 1:7){
  media_fluxes_list[[j]] = media_fluxes_list[[j]] + theme(plot.margin = margin(0.5, 0.15, 0.15, 0.15, "inches"))
}

spec_legend = g_legend(media_fluxes_list[[38]])
media_fluxes_list[[38]] = media_fluxes_list[[38]] + guides(col=F, shape = F)
media_fluxes_list[[39]] = plot_grid(spec_legend)
media_fluxes_plot2 = plot_grid(plotlist=media_fluxes_list, rel_widths = c(rep(1, 38), 3), ncol = 7, labels = media_mets, label_fontface="plain", label_size = 8, label_x = c(rep(0.2, 10), -0.1, rep(0.2, 27)), label_y = c(rep(0.8,7), rep(1, 31)))

non_media_fluxes_list = lapply(nonmedia_mets, function(x){
  make_met_plot(x, all_met_fluxes_final_plot, version = "allFluxes") 
})
for(j in 1:7){
  non_media_fluxes_list[[j]] = non_media_fluxes_list[[j]] + theme(plot.margin = margin(0.5, 0.15, 0.15, 0.15, "inches"))
}
nonmedia_fluxes_plot2 = plot_grid(plotlist = non_media_fluxes_list, nrow = 2, labels = nonmedia_mets, label_fontface="plain", label_size = 8,label_x = 0.2, label_y = c(rep(0.8, 7), rep(1, 7)))
media_fluxes_all = plot_grid(media_fluxes_plot2, nonmedia_fluxes_plot2, labels = c("Metabolites in nutrient inflow", "Non-inflow metabolites"), nrow = 2, rel_heights = c(38, 13))
save_plot(media_fluxes_all, file = "allMetFluxes.png", base_width = 12, base_height = 12)


```


Contribution properties

```{r, echo=F, message=F, warning=F}
contrib_threshold_pos = 0.1
contrib_threshold_mag = 0.2
shap_contribs[,BinaryContribPos:=ifelse(PosVarShare > contrib_threshold_pos, 1, 0)]
shap_contribs[,BinaryContribMag:=ifelse(VarShareMagnitude > contrib_threshold_mag, 1, 0)]

shap_contribs[,sum(BinaryContribPos), by=niceLab][,table(V1)]
shap_contribs[,sum(BinaryContribMag), by=niceLab][,table(V1)]

shap_contribs[,sum(BinaryContribPos), by=niceLab][,mean(V1)]
shap_contribs[,sum(BinaryContribMag), by=niceLab][,mean(V1)]

shap_contribs[,sum(BinaryContribPos), by=list(niceLab,mediaMet)][,mean(V1), by=mediaMet]
shap_contribs[,sum(BinaryContribMag), by=list(niceLab, mediaMet)][,mean(V1), by=mediaMet]

shap_contribs[BinaryContribPos==1 & BinaryContribMag==1]
shap_contribs[BinaryContribPos==0 & BinaryContribMag==1 & VarShare > 0]

shap_contribs[BinaryContribPos==1, list(sum(SynthSamples > 0 & DegSamples==0), sum(SynthSamples == 0 & DegSamples > 0), sum(SynthSamples > 0 & DegSamples > 0)), by=niceLab]
shap_contribs[BinaryContribPos==1, list(sum(SynthSamples > 0 & DegSamples==0), sum(SynthSamples == 0 & DegSamples > 0), sum(SynthSamples > 0 & DegSamples > 0))]

met_list = as.character(shap_contribs[,unique(niceLab)])
num_shared_contrib_mets = data.table(melt(sapply(met_list, function(x){
  sapply(met_list, function(y){
    return(length(intersect(shap_contribs[as.character(niceLab)==x & BinaryContribPos==1, Species], shap_contribs[as.character(niceLab)==y & BinaryContribPos==1, Species])))
  })
})))

num_shared_contrib_mets[,valueMag:=sapply(1:nrow(num_shared_contrib_mets), function(x){
  return(length(intersect(shap_contribs[as.character(niceLab)==num_shared_contrib_mets[x,Var1] & BinaryContribMag==1, Species], shap_contribs[as.character(niceLab)==num_shared_contrib_mets[x,Var2]& BinaryContribMag==1, Species])))
})]
num_shared_contrib_mets = merge(num_shared_contrib_mets, path_key, by.x = "Var1", by.y = "niceLab")
num_shared_contrib_mets = merge(num_shared_contrib_mets, path_key, by.x = "Var2", by.y = "niceLab")
num_shared_contrib_mets = num_shared_contrib_mets[Var1 > Var2]
num_shared_contrib_mets[,mean(value), by=ifelse(Class2.x==Class2.y,1,0)]
num_shared_contrib_mets[,median(value), by=ifelse(Class2.x==Class2.y,1,0)]
num_shared_contrib_mets[,wilcox.test(value[Class2.x==Class2.y], value[Class2.x != Class2.y])]
num_shared_contrib_mets[,fisher.test(value > 0, Class2.x==Class2.y)]
num_shared_contrib_mets[,prop.table(table(value > 0, Class2.x==Class2.y), 1)]

# edge_list_w_rev = emm_to_edge_list(mimosa_pieces_revFix[[7]])
# write.table(edge_list_w_rev, file = "edge_list_revAGORA.txt", quote=F, row.names=F, sep = "\t")
# edge_list_w_rev = fread("edge_list_revAGORA.txt")
# edge_list_w_rev[,Reac:=gsub("[e]", "[env]", Reac, fixed = T)]
# edge_list_w_rev[,Prod:=gsub("[e]", "[env]", Prod, fixed = T)]
# currency_mets = edge_list_w_rev[,length(unique(KO)), by=Reac]
# currency_mets = merge(currency_mets, edge_list_w_rev[,length(unique(KO)), by=Prod], by.x = "Reac", by.y = "Prod", all = T)
# 
# num_shared_contrib_mets[,Dist:=sapply(1:nrow(num_shared_contrib_mets), function(x){ return(num_shared_contrib_mets[x, get_net_dist(medium.x, medium.y, edge_list_w_rev)])})] 
# num_shared_contrib_mets[,cor.test(value, Dist, method="spearman")]
# num_shared_contrib_mets[!medium.x %in% currency_mets & !medium.y %in% currency_mets,cor.test(value, Dist, method="spearman")]
# num_shared_contrib_mets[!medium.x %in% currency_mets & !medium.y %in% currency_mets, wilcox.test(value[Dist < 3], value[Dist >= 3])]
# num_shared_contrib_mets[!medium.x %in% currency_mets & !medium.y %in% currency_mets,wilcox.test(Dist[value==0], Dist[value !=0])]
# num_shared_contrib_mets[,wilcox.test(Dist[value==0], Dist[value !=0])]

num_shared_contrib_mets[,mean(valueMag), by=ifelse(Class2.x==Class2.y,1,0)]
num_shared_contrib_mets[,median(valueMag), by=ifelse(Class2.x==Class2.y,1,0)]
num_shared_contrib_mets[,wilcox.test(valueMag[Class2.x==Class2.y], valueMag[Class2.x != Class2.y])]
num_shared_contrib_mets[,fisher.test(valueMag > 0, Class2.x==Class2.y)]
num_shared_contrib_mets[!medium.x %in% currency_mets & !medium.y %in% currency_mets,cor.test(valueMag, Dist, method="spearman")]
#num_shared_contrib_mets[!medium.x %in% currency_mets & !medium.y %in% currency_mets, wilcox.test(valueMag[Dist < 3], valueMag[Dist >= 3])]
# num_shared_contrib_mets[!medium.x %in% currency_mets & !medium.y %in% currency_mets,median(Dist), by=value==0]
# num_shared_contrib_mets[!medium.x %in% currency_mets & !medium.y %in% currency_mets,mean(value), by=Dist > 1]


num_shared_contribs = data.table(melt(sapply(spec_codes[1:10, Species], function(x){
  sapply(spec_codes[1:10, Species], function(y){
    return(length(intersect(shap_contribs[Species==x & BinaryContribPos==1, niceLab], shap_contribs[Species==y & BinaryContribPos==1, niceLab])))
  })
})))
num_shared_contribs = merge(num_shared_contribs, spec_codes, by.x = "Var1", by.y = "Species")
num_shared_contribs = merge(num_shared_contribs, spec_codes, by.x = "Var2", by.y = "Species")
num_shared_contribs = num_shared_contribs[Var1 > Var2]
num_shared_contribs[,valueMag:=sapply(1:nrow(num_shared_contribs), function(x){
  return(length(intersect(shap_contribs[Species==num_shared_contribs[x,Var1] & BinaryContribMag==1, niceLab], shap_contribs[Species==num_shared_contribs[x,Var2]& BinaryContribMag==1, niceLab])))
})]
num_shared_contribs[,mean(value), by=ifelse(Phylum.x==Phylum.y,1,0)]
num_shared_contribs[,wilcox.test(value[Phylum.x==Phylum.y], value[Phylum.x!=Phylum.y])]

num_shared_contribs[,mean(valueMag), by=ifelse(Phylum.x==Phylum.y,1,0)]
num_shared_contribs[,wilcox.test(valueMag[Phylum.x==Phylum.y], valueMag[Phylum.x!=Phylum.y])]

#Do species with more compounds in their metabolic networks contribute to more metabolites?
contribs_spec = shap_contribs[,list(sum(BinaryContribPos), sum(BinaryContribMag)), by=Code.x]

# comps_per_spec = data.table(spec_codes[1:10], NumMets = sapply(mimosa_pieces_revFix[[6]], function(x){
#   impacted_mets = apply(x[,2:ncol(x),with=F], 1, function(x){ length(x[x!=0])}) #Should be all of them
#   return(length(impacted_mets[impacted_mets !=0]))
# }), NumRxns = sapply(mimosa_pieces_revFix[[6]], function(x){
#   impacted_mets = apply(x[,2:ncol(x),with=F], 2, function(x){ length(x[x!=0])}) #Should be all of them
#   return(length(impacted_mets[impacted_mets !=0]))
# })
# )
# contribs_spec = merge(contribs_spec, comps_per_spec, by.x = "Code.x", by.y = "Code")
# contribs_spec[,cor.test(NumMets, V1, method="spearman")]
# contribs_spec[,cor.test(NumRxns, V1, method="spearman")]
# contribs_spec[,cor.test(NumMets, V2, method="spearman")]
# contribs_spec[,cor.test(NumRxns, V2, method="spearman")]

contribs_mets = shap_contribs[,list(sum(BinaryContribPos), sum(BinaryContribMag)), by=list(Metabolite, compound, niceLab,Mean.x, TrueVar, mediaMet)]
contribs_mets[,CoefVar:=TrueVar/Mean.x]
contribs_mets[,cor.test(V1, TrueVar, method="spearman")] 
contribs_mets[,cor.test(V1, Mean.x, method="spearman")]
contribs_mets[,cor.test(V1, CoefVar, method="spearman")]
contribs_mets[,cor.test(V2, TrueVar, method="spearman")] 
contribs_mets[,cor.test(V2, Mean.x, method="spearman")]
contribs_mets[,cor.test(V2, CoefVar, method="spearman")]
contribs_mets[,wilcox.test(TrueVar[V1==1], TrueVar[V1 > 1])]
contribs_mets[,wilcox.test(Mean.x[V1==1], Mean.x[V1 > 1])]
contribs_mets[,fisher.test(mediaMet, V1 > 1)]

mean_spec = fake_spec[,mean(value), by=Code]
contribs_spec = merge(contribs_spec, mean_spec, by.x = "Code.x", by.y = "Code")
contribs_spec[,cor.test(V1.x, V1.y, method="spearman")]

met_counts_melt = melt(contribs_mets[,list(niceLab, V1, V2)], id.var = "niceLab")
met_counts_melt[variable=="V1", ContribType:="Key contributors"]
met_counts_melt[variable=="V2", ContribType:="Key players"]
met_dist_mag = ggplot(met_counts_melt, aes(x=value)) + geom_histogram(binwidth=1, fill = "grey90", col="black") + scale_x_continuous(breaks = c(0,2,4,6,8,10), expand=c(0,0)) + xlab(paste0("Number of key contributors/players")) + theme(strip.background = element_blank(), plot.margin = margin(0.3, 0.3, 0.2, 0.3, "inches")) + ylab("Number of metabolites") + scale_y_continuous(limits = c(0, 37), expand= c(0,0)) + facet_wrap(~ContribType)

shap_contribs[,Code.x:=factor(Code.x, levels = spec_codes[,Code])]
num_contribs_tax = ggplot(shap_contribs[BinaryContribPos==1], aes(x=Code.x, fill = Code.x)) + geom_bar(stat="count") + scale_fill_manual(values = col_spec, limits = spec_codes[1:10, Code]) + scale_y_continuous(expand = c(0,0), limits = c(0, 20), name = "Number of key contributions") + theme(axis.ticks = element_blank(), legend.title = element_blank(), plot.margin = margin(0.2, 0.1, 0.2, 0.3, "inches")) + xlab("")
num_players_tax = ggplot(shap_contribs[BinaryContribMag==1], aes(x=Code.x, fill = Code.x)) + geom_bar(stat="count") + scale_fill_manual(values = col_spec, limits = spec_codes[1:10, Code]) + scale_y_continuous(expand = c(0,0), limits = c(0, 24), name = "Number of key players") + theme(axis.ticks = element_blank(), legend.title = element_blank()) + xlab("")

fig_s5 = plot_grid(met_dist_mag,plot_grid(num_contribs_tax, num_players_tax + guides(fill = F), nrow = 1, rel_widths = c(1.25, 1), align = "h", axis = "tb"), nrow = 2, labels = c("A", "B"), rel_heights = c(1.1,1))
save_plot(fig_s5, file = "FigureS5_contribProperties.png", base_width = 8, base_height = 6)


```


Correlation Plots (Figure 3)

```{r, echo=F, message=F, warning=F}
fake_mets_melt_good = fake_mets_melt[niceLab %in% shap_contribs[,niceLab]]
fake_mets_melt_good[,Sample:=gsub("inout", "", Sample)]
spec_met_corrs = get_correlation_contrib_comparison(fake_spec, fake_mets_melt = fake_mets_melt_good, shap_contribs, outcome_var = "BinaryContribPos")

#How different are relative abundances?
fake_spec2 = copy(fake_spec)
fake_spec2[,value:=value/sum(value), by=SimRun]
spec_met_corrs_rel = get_correlation_contrib_comparison(fake_spec2, fake_mets_melt_good, shap_contribs, outcome_var = "BinaryContribPos")
spec_met_corrs_compare = merge(spec_met_corrs, spec_met_corrs_rel[,list(Species,niceLab, estimate, p.value)], by=c("Species", "niceLab"), all=T)
spec_met_corrs_compare[,table(p.value.x < 0.01, p.value.y < 0.01)]
spec_met_corrs_compare[,list(sum(p.value.x < 0.01), sum(p.value.y < 0.01))]

spec_met_corrs[,Outcome_v2:=ifelse(BinaryContribPos==1 & p.value < 0.01, "True positive", "True negative")]
spec_met_corrs[,Outcome_v2:=ifelse(BinaryContribPos==1 & p.value > 0.01, "False negative", Outcome_v2)]
spec_met_corrs[,Outcome_v2:=ifelse(BinaryContribPos==0 & p.value < 0.01, "False positive", Outcome_v2)]
spec_met_corrs[,CorrResult:=ifelse(p.value < 0.01, "Correlated", "Not\ncorrelated")]
spec_met_corrs[,BinaryWord:=ifelse(BinaryContribPos==1, "Key contributor", "Non-contributor")]

spec_met_corrs[,table(Outcome)]
spec_met_corrs[,sum(grepl("True", Outcome))/length(Outcome)]
spec_met_corrs[,sum(grepl("True", Outcome))/length(Outcome), by=mediaMet]
#Sensitivity
spec_met_corrs[BinaryContribPos==1,length(BinaryContribPos[Outcome_v2=="True positive"])/length(BinaryContribPos)] 
#Specificity
spec_met_corrs[BinaryContribPos==0, length(BinaryContribPos[Outcome_v2=="True negative"])/length(BinaryContribPos)]
#Precision/FDR
spec_met_corrs[p.value < 0.01, length(BinaryContribPos[Outcome=="TruePos"])/length(BinaryContribPos)]

spec_met_corrs[,Outcome_v3:=ifelse(BinaryContribMag==1 & p.value < 0.01, "True positive", "True negative")]
spec_met_corrs[,Outcome_v3:=ifelse(BinaryContribMag==1 & p.value > 0.01, "False negative", Outcome_v3)]
spec_met_corrs[,Outcome_v3:=ifelse(BinaryContribMag==0 & p.value < 0.01, "False positive", Outcome_v3)]

spec_met_corrs[,table(Outcome_v3)]
spec_met_corrs[,sum(grepl("True", Outcome_v3))/length(Outcome_v3)]
spec_met_corrs[,sum(grepl("True", Outcome_v3))/length(Outcome), by=mediaMet]
#Sensitivity
spec_met_corrs[BinaryContribMag==1,length(BinaryContribMag[Outcome_v3=="True positive"])/length(BinaryContribPos)] 
#Specificity
spec_met_corrs[BinaryContribMag==0, length(BinaryContribPos[Outcome_v3=="True negative"])/length(BinaryContribPos)]
#Precision/FDR
spec_met_corrs[p.value < 0.01, length(BinaryContribMag[Outcome_v3=="True positive"])/length(BinaryContribPos)]
spec_met_corrs[p.value < 0.01 & BinaryContribPos==0, sum(SynthSamples==0 & DegSamples==0)/length(SynthSamples)]

corr_compare_plot2 = ggplot(spec_met_corrs[!Species %in% c("Inflow", "Outflow")], aes(x=VarShare, y = estimate,shape = BinaryWord, col = BinaryWord)) +
  geom_point(size = 0.65, alpha = 0.7) + xlim(-3,3)  + ylim(-1,1) + scale_color_manual(values = c("blue", "black")) + geom_hline(yintercept=0.33, linetype=2) + geom_hline(yintercept=-0.33, linetype = 2)+ theme(legend.title = element_blank(), legend.position = c(-0.22, -0.32)) + scale_shape_manual(values = c(16,1))+ ylab("Spearman correlation") + xlab("Contribution value") + guides(color = guide_legend(override.aes = list(size=1.5), ncol=2))#+ guides(shape = F)

roc_dat = make_ROC(spec_met_corrs, outcome_var = "BinaryContribPos", measure_var = "CorScaleAbs")
get_AUC(roc_dat)
ROC_plot1 =ggplot(roc_dat, aes(x=fpr, y = tpr)) + geom_line(size=1.5, color = brewer.pal(3, "Set1")[1])  + xlab("FPR") + ylab("TPR") + theme(legend.title = element_blank())+ geom_abline(slope=1, intercept=0, linetype=2) + annotate("text", x=0.75, y =0.25, label = "AUC = 0.717", size = 4.5)

corr_barplot = ggplot(spec_met_corrs, aes(x=CorrResult, fill = factor(Outcome_v2, levels = c("False negative", "True positive", "False positive", "True negative")))) + geom_bar(position="stack", stat="count") + scale_fill_manual(values = c("grey50", "grey50", "grey80", "grey80")) + theme(legend.title = element_blank(), axis.ticks = element_blank(), axis.text = element_text(size=15), axis.title = element_text(size=15)) + xlab("") + ylab("Number of\nspecies-metabolite pairs") + scale_y_continuous(expand=c(0,0)) + guides(fill = F) + annotate("text", x = "Correlated", y = 170, label = "True positive", col = "white",size = 3.5) + annotate("text", x = "Correlated", y = 80, label = "False positive", col = "black",size = 3.5) + annotate("text", x = "Not\ncorrelated", y = 150, label = "True negative", col = "black",size = 3.5) + annotate("text", x = "Not\ncorrelated", y = 315, label = "False negative", col = "white",size = 3.5)

counts_by_class = spec_met_corrs[,length(Species), by=list(Outcome_v2,Class2)]
counts_by_class_wide = dcast(counts_by_class, Class2~Outcome_v2, value.var="V1", fill = 0)
counts_by_class_wide[,Accuracy:=(`True positive`+`True negative`)/(`True positive`+`True negative`+`False positive`+`False negative`)]
counts_by_class_wide[,PPV:=(`True positive`)/(`True positive`+`False positive`)]
counts_by_class_wide[,Sens:=(`True positive`)/(`True positive`+`False negative`)]
counts_by_class_wide[,Spec:=(`True negative`)/(`True negative`+`False positive`)]
counts_by_class_melt = melt(counts_by_class_wide[,list(Class2, Accuracy, Sens, Spec, PPV)], id.var = "Class2")
counts_by_class_melt[Class2=="Amino acid metabolites", Class2:="Amino acid\nmetabolites"]
counts_by_class_melt[variable=="PPV", variable:="Positive predictive\nvalue (1-FDR)"]
counts_by_class_melt[,Class2:=factor(Class2, levels = c("Monosaccharides", "Carboxylic acids", "Fatty acids", "Amino acids", "Amino acid\nmetabolites", "Bases", "Vitamins", "Other"))]

met_accuracy2 = ggplot(counts_by_class_melt[!variable %in% c("Sens", "Spec")], aes(x=Class2, y = value)) + geom_bar(stat="identity", position = position_dodge(), col = "black", fill = "grey95") +geom_hline(yintercept=0, size=1)+facet_wrap(~variable, strip.position = "left", nrow = 2)+theme( legend.title = element_blank(), panel.spacing = unit(0.2, "inches"), axis.ticks.x = element_blank(), axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 10), axis.title.y = element_blank(), strip.placement = "outside", strip.background = element_blank(), axis.text.y = element_text(size=10), strip.text = element_text(size=14)) + scale_y_continuous(expand=c(0,0), limits = c(0,1)) + xlab("")# + scale_fill_manual(values = palette = "Dark2") + xlab("")  #, strip.position = "left"

counts_by_spec = spec_met_corrs[,length(unique(Metabolite)), by=list(Outcome_v2,SpeciesName)]
counts_by_spec_wide = dcast(counts_by_spec[!is.na(Outcome_v2)], SpeciesName~Outcome_v2, value.var="V1", fill = 0)
counts_by_spec_wide[,Accuracy:=(`True positive`+`True negative`)/(`True positive`+`True negative`+`False positive`+`False negative`)]
counts_by_spec_wide[,PPV:=`True positive`/(`True positive`+`False positive`)] #This is PPV
counts_by_spec_wide[,SpeciesName:=factor(SpeciesName, levels=spec_codes[,SpeciesName])]

counts_by_spec_melt = melt(counts_by_spec_wide[,list(SpeciesName, Accuracy, PPV)], id.var = "SpeciesName")
counts_by_spec_melt = merge(counts_by_spec_melt, spec_codes, by = "SpeciesName")
counts_by_spec_melt[variable=="PPV", variable:="Positive predictive\nvalue (1-FDR)"]
counts_by_spec_melt[,Code:=factor(Code, levels = rev(spec_codes[,Code]))]
spec_accuracy2 = ggplot(counts_by_spec_melt, aes(x=Code, y = value, fill = Code)) + geom_bar(stat="identity", position = position_dodge(), col = "black")+geom_hline(yintercept=0, size=1)+facet_wrap(~variable, strip.position = "left", nrow = 2)+theme( legend.title = element_blank(), panel.spacing = unit(0.2, "inches"), axis.ticks.x = element_blank(), axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), axis.title.y = element_blank(), axis.text.y = element_text(size=10),  strip.placement = "outside", strip.background = element_blank(), strip.text = element_blank()) + scale_y_continuous(expand=c(0,0), limits = c(0,1)) + xlab("") + scale_fill_manual(values = col_spec) + xlab("") + guides(fill = F)  #, strip.position = "left"

class_plots = plot_grid(met_accuracy2+ theme(plot.margin = margin(0.5, 0.1, 0.1, 0.1, "inches")), spec_accuracy2+ theme(plot.margin = margin(0.5, 0.1, 1, 0.1, "inches")), nrow = 1, labels = c("D","E"), rel_widths = c(1.2, 1), label_y = 0.985)

fig3 = plot_grid(plot_grid(corr_barplot+ theme(plot.margin = margin(0.3, 1.5, -0.02, 1.2, "inches"), panel.spacing = unit(0, "inches")), plot_grid(ROC_plot1 + theme(plot.margin = margin(0, 0.2, 0.4, 0.2, "inches")), corr_compare_plot2 + theme(plot.margin = margin(0, 0.1, 0.4, 0.2, "inches"), legend.box.margin = margin(0.01,0.01, 0.1, 0.01, "inches"), panel.spacing = unit(0, "inches")), nrow = 1, labels = c("B", "C"), label_y = 0.985, align = "h", axis = "b"), nrow = 2, rel_heights = c(1.25, 1)), class_plots, nrow = 1, labels = c("A", "", ""), label_y = 0.985)#, rel_ = c(1, 1, 1.7))
save_plot(fig3, file = "Figure3_corrs_alt.png", base_width = 12, base_height = 6.5)


###Alternative correlation thresholds
0.05/520 #bonferroni cutoff
spec_met_corrs[p.value < 0.0001, sum(BinaryContribPos)/length(BinaryContribPos)]
spec_met_corrs[,(sum(p.value < 0.0001 & BinaryContribPos==1)+sum(p.value > 0.0001 & BinaryContribPos==0))/length(BinaryContribPos)]
spec_met_corrs[p.value < 0.05, sum(BinaryContribPos)/length(BinaryContribPos)]
spec_met_corrs[,(sum(p.value < 0.05 & BinaryContribPos==1)+sum(p.value > 0.05 & BinaryContribPos==0))/length(BinaryContribPos)]

spec_met_corrs[BinaryContribPos==0,sum(p.value > 0.05)/length(p.value)]
spec_met_corrs[BinaryContribPos==1,sum(p.value < 0.05)/length(p.value)]
spec_met_corrs[BinaryContribPos==1,sum(p.value < 0.01)/length(p.value)]



```


False positive/ false negative analysis (Figure 4)

```{r, echo=F, message=F, warning=F}

falsepos_met = glm(factor(FalsePos)~niceLab, data=spec_met_corrs[BinaryContribPos==0], family="binomial")
falsepos_spec = glm(factor(FalsePos)~Species, data=spec_met_corrs[BinaryContribPos==0], family="binomial")
falsepos_both = glm(factor(FalsePos)~Species+niceLab, data=spec_met_corrs[BinaryContribPos==0], family="binomial")
anova(falsepos_met, test = "LRT")
anova(falsepos_spec, test = "LRT")

anova(falsepos_both, falsepos_met, test = "LRT")
anova(falsepos_both, falsepos_spec, test = "LRT")

species_corrs = rbindlist(lapply(spec_codes[1:10,SpeciesName], function(x){
  foo = merge(fake_spec[SpeciesName==x], fake_spec[SpeciesName !=x], by=c("SimRun", "Sample"))
  return(foo[,cor(value.x, value.y), by=list(SpeciesName.x, SpeciesName.y)])
  }))
meanCorr = species_corrs[,list(mean(abs(V1)), max(abs(V1)), SpeciesName.y[which.max(abs(V1))]), by=SpeciesName.x]
setnames(meanCorr, c("V1", "V2", "V3"), c("meanCorrOtherSpec", "maxCorrOtherSpec", "maxCorrSpecies"))
spec_met_corrs = merge(spec_met_corrs, meanCorr, by.x = "SpeciesName", by.y = "SpeciesName.x")
species_corrs[,median(abs(V1))]

species_counts = rbindlist(lapply(spec_codes[1:10, SpeciesName], function(x){
  met_c = spec_met_corrs[BinaryContribPos==1 & SpeciesName==x, niceLab]
  compare_dat = spec_met_corrs[niceLab %in% met_c, list(sum(FalsePos), sum(BinaryContribPos), length(unique(niceLab))), by=SpeciesName]
  compare_dat[,ContribSpecies:=x]
  return(compare_dat)
}))

species_counts = merge(species_counts, species_corrs, by.x = c("SpeciesName", "ContribSpecies"), by.y = c("SpeciesName.x", "SpeciesName.y"), all = T)
setnames(species_counts, c("V1.x", "V2", "V3", "V1.y"), c("FalsePos", "SharedContribs","TotContribs", "Corr"))
species_counts[,FalsePosPossible:=TotContribs-SharedContribs]
species_counts = species_counts[ContribSpecies != SpeciesName]

corr_mat = dcast(species_corrs, SpeciesName.x~SpeciesName.y)
corr_mat[is.na(corr_mat)] = 1
corr_mat = merge(corr_mat, spec_codes, by.x = "SpeciesName.x", by.y = "SpeciesName")
corr_mat[,SpeciesName.x:=factor(SpeciesName.x, levels = names(corr_mat)[2:11])]
corr_mat = corr_mat[order(SpeciesName.x)]
dist_mat = 1-abs(as.matrix(corr_mat[,2:11,with=F]))
spec_clust = hclust(as.dist(dist_mat))

species_counts = merge(species_counts, spec_codes, by = "SpeciesName")
species_counts = merge(species_counts, spec_codes, by.x = "ContribSpecies", by.y = "SpeciesName")
species_counts[,Code.x:=factor(Code.x, levels = corr_mat[spec_clust$order, Code])]
species_counts[,Code.y:=factor(Code.y, levels = corr_mat[spec_clust$order, Code])]
#species_counts[,ContribSpecies:=factor(ContribSpecies, levels = corr_mat[spec_clust$order, SpeciesName.x])]

false_pos_pairs = spec_met_corrs[p.value < 0.01 & FalsePos==1, list(SpeciesName, niceLab, maxCorrSpecies)]

false_pos_pairs = merge(false_pos_pairs, spec_met_corrs[BinaryContribPos==1, list(niceLab, SpeciesName, BinaryContribPos)], by.x = c("maxCorrSpecies", "niceLab"), by.y = c("SpeciesName", "niceLab"), all.x = T)
(spec_met_corrs[p.value < 0.01,sum(FalsePos==0)]+nrow(false_pos_pairs[!is.na(BinaryContribPos)]))/spec_met_corrs[p.value < 0.01, length(FalsePos)]

falsepos_plot2 = ggplot(species_counts[FalsePosPossible > 0], aes(x=Code.y, y = Code.x)) + geom_tile(aes(fill = abs(Corr))) + geom_point(fill=NA, shape=21, color="black", stroke = 1.1, aes(size = FalsePosPossible)) + geom_point(col = "grey30", shape = 21, fill = NA,stroke = 1.1, aes(size = FalsePos)) + theme(axis.text.x = element_text(angle = 90, hjust=1, vjust=0.5, face = "italic"), axis.text.y = element_text(face="italic"), axis.ticks = element_blank(), legend.title = element_text(size = 11)) + scale_fill_gradient2(low = "grey40", high = scales::muted("green", l = 50)) + xlab("Contributor species") + ylab("False positive species") + scale_size_area() + guides(fill = guide_colorbar(title = "Correlation\nmagnitude"), size = guide_legend(override.aes = list(shape = 21, fill=NA), title = "N observed (inner\ngrey) or possible\n(outer black)\nfalse positives")) + theme(panel.background = element_rect(fill = "grey80")) + scale_x_discrete(expand = c(0,0)) + scale_y_discrete(expand = c(0,0))

#Check if species abundance/var has a role
spec_summary = fake_spec[,list(mean(value), var(value)), by=SpeciesName]
counts_by_spec_wide = merge(counts_by_spec_wide, spec_summary, by = "SpeciesName")
counts_by_spec_wide[,cor(V1, `False positive`)]
counts_by_spec_wide[,cor(V2, `False positive`)]

species_counts[,cor.test(FalsePos/FalsePosPossible, abs(Corr), method = "spearman")]
species_pvals = rbindlist(lapply(spec_codes[1:10,SpeciesName], function(x){
  foo = merge(fake_spec[SpeciesName==x], fake_spec[SpeciesName !=x], by=c("SimRun", "Sample"))
  return(foo[,cor.test(value.x, value.y)$p.value, by=list(SpeciesName.x, SpeciesName.y)])
}))
setnames(species_pvals, c("ContribSpecies", "SpeciesName", "PvalueCorr"))
species_counts = merge(species_counts, species_pvals, by = c("ContribSpecies", "SpeciesName"), all.x=T)
species_counts[,wilcox.test(FalsePos/FalsePosPossible[PvalueCorr < 0.01], FalsePos/FalsePosPossible[PvalueCorr > 0.0001])]

species_counts = merge(species_counts, spec_summary, by = "SpeciesName")
species_counts = merge(species_counts, spec_summary, by.x = "ContribSpecies", by.y = "SpeciesName")
setnames(species_counts, c("V1.x", "V2.x", "V1.y", "V2.y"), c("FPMean", "FPVar", "ContribMean", "ContribVar"))
species_counts[,cor.test(FPMean, FalsePos/FalsePosPossible, method="spearman")]
species_counts[,cor.test(FPVar, FalsePos/FalsePosPossible, method="spearman")]
species_counts[,cor.test(ContribMean, FalsePos/FalsePosPossible, method="spearman")]
species_counts[,cor.test(ContribVar, FalsePos/FalsePosPossible, method="spearman")]

counts_by_spec_wide = merge(counts_by_spec_wide, meanCorr, by.x = "SpeciesName", by.y = "SpeciesName.x")

#spec_met_corrs = merge(spec_met_corrs, meanCorr, by.x = "SpeciesName", by.y = "SpeciesName.x", all.x = T)
counts_by_spec_wide = merge(counts_by_spec_wide, spec_codes, by = "SpeciesName", all.x = T)


counts_by_spec_wide[,Spec:=(`True negative`)/(`True negative`+`False positive`)]
counts_by_spec_wide[,cor.test(maxCorrOtherSpec, Spec, method="spearman")]

contribs_wide = dcast(spec_met_corrs, niceLab~Code.x, value.var="BinaryContribPos")
good_mets2 = contribs_wide[(Er==1 & Bt==0 & Bo==0)|(Er==0 & Bt==1 & Bo==0)|(Er==0& Bt==0 & Bo==1), niceLab]
good_mets1 = contribs_wide[(Er==1 & Bt==1 & Bo==0)|(Er==1 & Bt==0 & Bo==1)|(Er==0& Bt==1 & Bo==1), niceLab]

big_spec = c("Er", "Bt", "Bo")
spec_met_corrs[Code.x %in% big_spec & (niceLab %in% good_mets2|niceLab %in% good_mets1) & BinaryContribPos==0, sum(FalsePos)/length(FalsePos)]
spec_met_corrs[Code.x %in% big_spec & FalsePos==1, sum((niceLab %in% good_mets1)|(niceLab %in% good_mets2))/length(niceLab)]

################# False negatives

falseneg_met = glm(factor(FalseNeg)~niceLab, data=spec_met_corrs[BinaryContribPos==1], family="binomial")
falseneg_spec = glm(factor(FalseNeg)~Species, data=spec_met_corrs[BinaryContribPos==1], family="binomial")
falseneg_both = glm(factor(FalseNeg)~Species+niceLab, data=spec_met_corrs[BinaryContribPos==1], family="binomial")

falseneg_alt2 = glm(factor(FalseNeg)~Species+Class2, data=spec_met_corrs[BinaryContribPos==1], family="binomial")
anova(falseneg_spec, falseneg_alt2, test = "LRT")

anova(falseneg_met, test = "LRT")
anova(falseneg_spec, test = "LRT")

anova(falseneg_both, falseneg_met, test = "LRT")
anova(falseneg_both, falseneg_spec, test = "LRT")

met_level_outcomes = spec_met_corrs[,list(sum(FalsePos), sum(TrueNeg), sum(FalseNeg), sum(TruePos)), by=list(niceLab, Mean.x, Variance,CoefVar, mediaMet)]
setnames(met_level_outcomes, c("V1", "V2", "V3", "V4"), c("FalsePos", "TrueNeg", "FalseNeg", "TruePos"))
met_level_outcomes[,Accuracy:=(TrueNeg+TruePos)/10]
met_level_outcomes[,PPV:=TruePos/(TruePos+FalsePos)]
met_level_outcomes[,Spec:=TrueNeg/(TrueNeg+FalseNeg)]
met_level_outcomes[,Sens:=TruePos/(TruePos+FalseNeg)]

samp_spec_counts = all_met_fluxes_final[niceLab %in% shap_contribs[,unique(niceLab)] & Code != "in", length(cumulFlux[cumulFlux !=0]), by=list(SpeciesName, niceLab)]
spec_counts = samp_spec_counts[,length(V1[V1 !=0]), by=niceLab]
setnames(spec_counts, "V1", "NumSpec")
num_contribs = spec_met_corrs[,sum(BinaryContribPos), by=niceLab]
setnames(num_contribs, "V1", "NumContribs")  
num_neg_contribs = spec_met_corrs[,list(length(VarShare[VarShare < 0]), length(VarShare[VarShare < -0.05]), length(VarShare[BinaryContribMag==1 & VarShare< 0]), length(VarShare[VarShareMagnitude > 0.05])), by=niceLab]
setnames(num_neg_contribs, c("V1", "V2", "V3", "V4"), c("NumNegContrib","NumNeg5", "NumNegKeyPlayer", "NumMag05"))
max_neg_contrib = spec_met_corrs[,max(abs(VarShare)[VarShare < 0]), by=niceLab]
setnames(max_neg_contrib,"V1", "maxNegContrib")
met_level_outcomes = merge(met_level_outcomes, spec_counts, by = "niceLab")
met_level_outcomes = merge(met_level_outcomes, num_contribs, by = "niceLab")
met_level_outcomes = merge(met_level_outcomes, num_neg_contribs, by = "niceLab")
met_level_outcomes = merge(met_level_outcomes, max_neg_contrib, by = "niceLab")


spec_met_corrs = merge(spec_met_corrs, met_level_outcomes[,list(niceLab, NumSpec)], by="niceLab")
spec_met_corrs[,wilcox.test(NumSpec[FalseNeg==1], NumSpec[FalseNeg==0])]

met_corr_avg = spec_met_corrs[BinaryContribPos==1, list(mean(abs(estimate)), sum(BinaryContribPos)), by=niceLab]
met_corr_avg[,cor.test(V1, V2, method="spearman")]

spec_met_corrs[BinaryContrib==1,wilcox.test(NumSpec[FalseNeg==1], NumSpec[FalseNeg==0])]
spec_met_corrs[BinaryContrib==1,list(summary(NumSpec[FalseNeg==1]), summary(NumSpec[FalseNeg==0]))]

spec_met_corrs[,table(VarShare < 0, grepl("True",Outcome))]
spec_met_corrs[,prop.table(table(VarShare < 0, grepl("True",Outcome)),1)]
spec_met_corrs[,prop.table(table(VarShare < 0, grepl("True",Outcome)),1)]
spec_met_corrs[,fisher.test(table(VarShare < 0, grepl("True",Outcome)),1)] #negative contributors are slightly less likely to be correctly id'd

spec_met_corrs[,sum(Outcome_v2=="False positive")]
spec_met_corrs[,sum(Outcome_v2=="False negative")]
spec_met_corrs[,sum(Outcome_v2=="False positive" & SynthSamples==0 & DegSamples==0)]
counts_by_spec_wide[,range(Spec)]

samp_counts = shap_contribs[,list(length(SynthSamples[SynthSamples > 0 & VarShare < 0]), length(DegSamples[DegSamples& VarShare > 0]), length(SynthSamples[SynthSamples > 0 & VarShare > 0]), length(DegSamples[DegSamples > 0 & VarShare < 0])), by=list(niceLab, mediaMet)] 
samp_counts[V1 > 0 | V4 > 0]#Negative contrib of some sort#[V1 > 0 & V2 > 0]
samp_counts[,crossfed:=ifelse((V1 > 0 & V2 > 0)|(V3 > 0 & V4 > 0), 1,0)]
met_level_outcomes = merge(met_level_outcomes, samp_counts, by=c("niceLab", "mediaMet"))
met_level_outcomes[,Synth:=ifelse(V1 > 0 | V3 > 0, "Export", "")]
met_level_outcomes[,Deg:=ifelse(V2 > 0 | V4 > 0, "Import", "")]
met_level_outcomes[,Method:=paste0(Synth,Deg)]
met_level_outcomes[,Method2:=ifelse(Method=="Export", "Exported", "Imported")]
met_level_outcomes[,Method2:=ifelse(Method=="ExportImport", "Crossfed", Method2)]
met_level_outcomes[,Method3:=ifelse(Method2=="Imported", "Utilized", "Secreted")]
met_level_outcomes[,Method3:=ifelse(Method2=="Crossfed", "Cross-fed", Method3)]
#Secreted, utilized, cross-fed

met_level_outcomes[,wilcox.test(Accuracy[crossfed==1], Accuracy[crossfed==0])]
met_level_outcomes[,wilcox.test(Sens[crossfed==1], Sens[crossfed==0])]
met_level_outcomes[,wilcox.test(Spec[crossfed==1], Spec[crossfed==0])]

met_level_outcomes[,cor.test(Sens, NumSpec, method="spearman")]
met_level_outcomes[,cor.test(Sens, NumContribs, method="spearman")]
met_level_outcomes[,cor.test(Sens, NumNeg5, method="spearman")]
met_level_outcomes[,cor.test(FalseNeg, NumContribs, method="spearman")]
met_level_outcomes[,cor.test(Accuracy, NumContribs, method="spearman")]
met_level_outcomes[,cor.test(Sens, NumNegContrib, method="spearman")]
met_level_outcomes[,cor.test(Sens, NumNegKeyPlayer, method="spearman")]
met_level_outcomes[,cor.test(FalseNeg, NumNegContrib, method="spearman")]
met_level_outcomes[,cor.test(FalseNeg, NumNegKeyPlayer, method="spearman")] #Never > 1 negative Key Player

met_level_outcomes[,table(NumNegKeyPlayer > 0, FalseNeg > 0)] #huh
met_level_outcomes[,table(NumNegContrib > 0, FalseNeg > 0)] 
met_level_outcomes[,table(NumNegContrib > 1, FalseNeg > 0)] 
met_level_outcomes[,table(NumSpec > 3, FalseNeg > 0)]
met_level_outcomes[,table(NumNegContrib)]
met_level_outcomes[,table(NumNegContrib > 1, FalseNeg > 0)]
met_level_outcomes[,fisher.test(table(NumNeg5 > 1, FalseNeg > 0))]
met_level_outcomes[,fisher.test(V1 > 0, FalseNeg > 0)]
met_level_outcomes[,table(V1 > 0)]
met_level_outcomes[,wilcox.test(Sens[V1==0], Sens[V1 > 0])]
met_level_outcomes[,fisher.test(table(NumNegContrib >0, FalseNeg > 0))]
met_level_outcomes[,fisher.test(crossfed, FalseNeg > 0)]
met_level_outcomes[,table(crossfed, FalseNeg > 0)]
met_level_outcomes[,table(mediaMet, FalseNeg > 0)]
met_level_outcomes[,fisher.test(table(mediaMet, FalseNeg > 0))]

met_level_outcomes[maxNegContrib != -Inf,wilcox.test(maxNegContrib[FalseNeg==0], maxNegContrib[FalseNeg != 0])]

spec_met_corrs[FalseNeg==1, length(niceLab[niceLab %in% met_level_outcomes[NumNegContrib > 1, niceLab]])/length(niceLab)]
spec_met_corrs[,sum(FalseNeg)]

spec_met_corrs = merge(spec_met_corrs, num_contribs, by = "niceLab")
spec_met_corrs[BinaryContribPos==1,ContribCount:=frank(FalseNeg, ties.method = "random"), by=niceLab]
contrib_order = spec_met_corrs[order(NumContribs, FalseNeg), unique(niceLab)]

num_contribs_plot2 = ggplot(spec_met_corrs[BinaryContribPos==1], aes(x=factor(niceLab, levels = rev(contrib_order)), y = ContribCount, fill = Outcome_v2)) + geom_tile(color="black")+ theme(axis.text.x = element_blank(), axis.ticks = element_blank(), axis.line = element_blank(), legend.position = "bottom", plot.margin = margin(0.2, 0.2, 0.1, 0.3, "inches"), panel.spacing = unit(0, "inches"), axis.text.y = element_blank()) + scale_fill_manual(values = c("grey90", "blue")) + guides(fill =  guide_legend(title = "")) + scale_y_continuous(expand = c(0,0), limits = c(-0.001, 5))+ ylab("Key contributors")+xlab("Metabolites") + scale_x_discrete(expand = c(0.01, 0)) #+ facet_wrap(~niceLab) # element_text(angle = 90, hjust=1, vjust=0.5)

met_level_outcomes[Method3=="Crossfed", Method3:="Cross-fed"]
met_impact_plot = ggplot(met_level_outcomes, aes(x=Method3, y = Accuracy, group=Method3)) + geom_boxplot() + geom_jitter() +xlim(c("Secreted", "Utilized", "Cross-fed"))+ scale_y_continuous(limits = c(0, 1.01)) + theme(axis.title.x = element_blank()) + ylab("Metabolite correlation accuracy")

fig4 = plot_grid(plot_grid(falsepos_plot2 + theme(plot.margin = margin(0.3, 0.15, 0, 0.3, "inches")), plot_grid(met_impact_plot + ylim(0, 1.03)+theme(axis.title.y = element_text(size=12), axis.title.x = element_blank(), plot.margin = margin(0.2, 0.2, 0.3, 0.05, "inches")),labels = c("C")), nrow = 1, rel_widths = c(1.45, 1), labels = c("A", "")), num_contribs_plot2, nrow = 2, rel_heights = c(2.12, 1), labels = c("", "B"))
save_plot(fig4, file = "Figure4_correlationReasons.png", base_width = 9, base_height = 5.75) # + coord_flip(ylim = c(0, 1.01))

```


Checking these results for key players (Figure S6)

```{r, echo=F, message=F, warning=F}

spec_met_corrs[,table(Outcome_v3)]
spec_met_corrs[,sum(grepl("True", Outcome_v3))/length(Outcome_v3)]
spec_met_corrs[,sum(grepl("True", Outcome_v3))/length(Outcome), by=mediaMet]
#Sensitivity
spec_met_corrs[BinaryContribMag==1,length(BinaryContribMag[Outcome_v3=="True positive"])/length(BinaryContribPos)] 
#Specificity
spec_met_corrs[BinaryContribMag==0, length(BinaryContribPos[Outcome_v3=="True negative"])/length(BinaryContribPos)]
#Precision/FDR
spec_met_corrs[p.value < 0.01, length(BinaryContribMag[Outcome_v3=="True positive"])/length(BinaryContribPos)]

roc_dat = make_ROC(spec_met_corrs, outcome_var = "BinaryContribMag", measure_var = "CorScaleAbs")
get_AUC(roc_dat)

ROC_plot1 =ggplot(roc_dat, aes(x=fpr, y = tpr)) + geom_line(size=1.5, color = brewer.pal(3, "Set1")[1])  + xlab("FPR") + ylab("TPR") + theme(legend.title = element_blank())+ geom_abline(slope=1, intercept=0, linetype=2) + annotate("text", x=0.75, y =0.25, label = "AUC = 0.717", size = 4.5)

corr_barplot = ggplot(spec_met_corrs, aes(x=CorrResult, fill = factor(Outcome_v3, levels = c("False negative", "True positive", "False positive", "True negative")))) + geom_bar(position="stack", stat="count") + scale_fill_manual(values = c("grey50", "grey50", "grey80", "grey80")) + theme(legend.title = element_blank(), axis.ticks = element_blank(), axis.text = element_text(size=15), axis.title = element_text(size=15)) + xlab("") + ylab("Number of\nspecies-metabolite pairs") + scale_y_continuous(expand=c(0,0)) + guides(fill = F) + annotate("text", x = "Correlated", y = 160, label = "True positive", col = "white",size = 3.5) + annotate("text", x = "Correlated", y = 80, label = "False positive", col = "black",size = 3.5) + annotate("text", x = "Not\ncorrelated", y = 150, label = "True negative", col = "black",size = 3.5) + annotate("text", x = "Not\ncorrelated", y = 315, label = "False negative", col = "white",size = 3.5)


counts_by_class = spec_met_corrs[,length(Species), by=list(Outcome_v3,Class2)]
counts_by_class_wide = dcast(counts_by_class, Class2~Outcome_v3, value.var="V1", fill = 0)
counts_by_class_wide[,Accuracy:=(`True positive`+`True negative`)/(`True positive`+`True negative`+`False positive`+`False negative`)]
counts_by_class_wide[,PPV:=(`True positive`)/(`True positive`+`False positive`)]
counts_by_class_wide[,Sens:=(`True positive`)/(`True positive`+`False negative`)]
counts_by_class_wide[,Spec:=(`True negative`)/(`True negative`+`False positive`)]
counts_by_class_melt = melt(counts_by_class_wide[,list(Class2, Accuracy, Sens, Spec, PPV)], id.var = "Class2")
counts_by_class_melt[Class2=="Amino acid metabolites", Class2:="Amino acid\nmetabolites"]

counts_by_class_melt[variable=="PPV", variable:="Positive predictive\nvalue (1-FDR)"]
counts_by_class_melt[,Class2:=factor(Class2, levels = c("Monosaccharides", "Carboxylic acids", "Fatty acids", "Amino acids", "Amino acid\nmetabolites", "Bases", "Vitamins", "Other"))]
met_accuracy2 = ggplot(counts_by_class_melt[variable %in% c("Accuracy", "Positive predictive\nvalue (1-FDR)")], aes(x=Class2, y = value)) + geom_bar(stat="identity", position = position_dodge(), col = "black", fill = "grey95") +facet_wrap(variable~., strip.position = "top", nrow = 2)+theme( legend.title = element_blank(), axis.ticks.x = element_blank(), axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 10), axis.title.y = element_blank(), strip.placement = "outside", strip.background = element_blank()) + scale_y_continuous(expand=c(0,0), limits = c(0,1)) + xlab("")# + scale_fill_manual(values = palette = "Dark2") + xlab("")  #, strip.position = "left"

counts_by_spec = spec_met_corrs[,length(unique(Metabolite)), by=list(Outcome_v3,SpeciesName)]
counts_by_spec_wide = dcast(counts_by_spec[!is.na(Outcome_v3)], SpeciesName~Outcome_v3, value.var="V1", fill = 0)
counts_by_spec_wide[,Accuracy:=(`True positive`+`True negative`)/(`True positive`+`True negative`+`False positive`+`False negative`)]
counts_by_spec_wide[,PPV:=`True positive`/(`True positive`+`False positive`)] #This is PPV
counts_by_spec_wide[,SpeciesName:=factor(SpeciesName, levels=spec_codes[,SpeciesName])]

counts_by_spec_melt = melt(counts_by_spec_wide[,list(SpeciesName, Accuracy, PPV)], id.var = "SpeciesName")
counts_by_spec_melt = merge(counts_by_spec_melt, spec_codes, by = "SpeciesName")
counts_by_spec_melt[variable=="PPV", variable:="Positive predictive\nvalue (1-FDR)"]
counts_by_spec_melt[,Code:=factor(Code, levels = rev(spec_codes[,Code]))]
spec_accuracy2 = ggplot(counts_by_spec_melt, aes(x=Code, y = value, fill = Code)) + geom_bar(stat="identity", position = position_dodge(), col = "black")+facet_wrap(variable~., strip.position = "top", nrow = 2)+theme( legend.title = element_blank(), axis.ticks.x = element_blank(), axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), axis.title.y = element_blank(), strip.placement = "outside", strip.background = element_blank()) + scale_y_continuous(expand=c(0,0), limits = c(0,1)) + xlab("") + scale_fill_manual(values = col_spec) + xlab("") + guides(fill = F)  #, strip.position = "left"


spec_met_corrs[,FalsePosMag:=ifelse(BinaryContribMag==0 & p.value < 0.01, 1, 0)]
spec_met_corrs[,FalseNegMag:=ifelse(BinaryContribMag==1 & p.value > 0.01, 1, 0)]
falsepos_met = glm(factor(FalsePosMag)~niceLab, data=spec_met_corrs[BinaryContribMag==0], family="binomial")
falsepos_spec = glm(factor(FalsePosMag)~Species, data=spec_met_corrs[BinaryContribMag==0], family="binomial")
falsepos_both = glm(factor(FalsePosMag)~Species+niceLab, data=spec_met_corrs[BinaryContribMag==0], family="binomial")
anova(falsepos_met, test = "LRT")
anova(falsepos_spec, test = "LRT")
anova(falsepos_both, test = "LRT")
falsepos_spec_maxCorr = glm(factor(FalsePosMag)~maxCorrOtherSpec, data = spec_met_corrs[BinaryContribMag==0], family="binomial")
falsepos_spec_meanCorr = glm(factor(FalsePosMag)~meanCorrOtherSpec, data = spec_met_corrs[BinaryContribMag==0], family="binomial")

falseneg_met = glm(factor(FalseNegMag)~niceLab, data=spec_met_corrs[BinaryContribMag==1], family="binomial")
falseneg_spec = glm(factor(FalseNegMag)~Species, data=spec_met_corrs[BinaryContribMag==1], family="binomial")
falseneg_both = glm(factor(FalseNegMag)~Species+niceLab, data=spec_met_corrs[BinaryContribMag==1], family="binomial")

falseneg_alt2 = glm(factor(FalseNegMag)~Species+Class2, data=spec_met_corrs[BinaryContribMag==1], family="binomial")
anova(falseneg_spec, falseneg_alt2, test = "LRT")

anova(falseneg_met, test = "LRT")
anova(falseneg_spec, test = "LRT")

anova(falseneg_met, falseneg_both, test = "LRT")
anova( falseneg_spec, falseneg_both,test = "LRT")
anova(falseneg_both, test = "LRT")
anova(falseneg_alt2, test = "LRT")

spec_met_corrs = merge(spec_met_corrs, spec_counts, by= "niceLab", all.x=T)
falseneg_alt = glm(factor(FalseNegMag)~NumSpec.x, data=spec_met_corrs[BinaryContribMag==1], family="binomial")
  
species_counts = rbindlist(lapply(spec_codes[1:10, SpeciesName], function(x){
  met_c = spec_met_corrs[BinaryContribMag==1 & SpeciesName==x, niceLab]
  compare_dat = spec_met_corrs[niceLab %in% met_c, list(sum(FalsePosMag), sum(BinaryContribMag), length(unique(niceLab))), by=SpeciesName]
  compare_dat[,ContribSpecies:=x]
  return(compare_dat)
}))

species_counts = merge(species_counts, species_corrs, by.x = c("SpeciesName", "ContribSpecies"), by.y = c("SpeciesName.x", "SpeciesName.y"), all = T)
setnames(species_counts, c("V1.x", "V2", "V3", "V1.y"), c("FalsePos", "SharedContribs","TotContribs", "Corr"))
species_counts[,FalsePosPossible:=TotContribs-SharedContribs]
species_counts = species_counts[ContribSpecies != SpeciesName]

species_counts = merge(species_counts, spec_codes, by = "SpeciesName")
species_counts = merge(species_counts, spec_codes, by.x = "ContribSpecies", by.y = "SpeciesName")
species_counts[,Code.x:=factor(Code.x, levels = corr_mat[spec_clust$order, Code])]
species_counts[,Code.y:=factor(Code.y, levels = corr_mat[spec_clust$order, Code])]

met_level_outcomes2 = dcast(spec_met_corrs, niceLab+Mean.x+Variance+mediaMet~Outcome_v3, value.var = "Outcome_v3")
met_level_outcomes2[,Accuracy:=(`True negative`+`True positive`)/10]
met_level_outcomes2[,PPV:=`True positive`/(`True positive`+`False positive`)]
met_level_outcomes2[,Spec:=`True negative`/(`True negative`+`False positive`)]
met_level_outcomes2[,Sens:=`True positive`/(`True positive`+`False negative`)]
met_level_outcomes2 = merge(met_level_outcomes2, met_level_outcomes[,list(niceLab, Method3)], by="niceLab")

met_impact_plot = ggplot(met_level_outcomes2, aes(x=Method3, y = Accuracy, group=Method3)) + geom_boxplot() + geom_jitter(width = 0.1, height = 0.1) +xlim(c("Secreted", "Utilized", "Cross-fed"))+ scale_y_continuous(limits = c(0, 1.03)) + theme(axis.title.x = element_blank()) + ylab("Metabolite correlation accuracy")

counts_by_class = spec_met_corrs[,length(Species), by=list(Outcome_v3,Class2)]
counts_by_class_wide = dcast(counts_by_class, Class2~Outcome_v3, value.var="V1", fill = 0)
counts_by_class_wide[,Accuracy:=(`True positive`+`True negative`)/(`True positive`+`True negative`+`False positive`+`False negative`)]
counts_by_class_wide[,PPV:=(`True positive`)/(`True positive`+`False positive`)]
counts_by_class_wide[,Sens:=(`True positive`)/(`True positive`+`False negative`)]
counts_by_class_wide[,Spec:=(`True negative`)/(`True negative`+`False positive`)]
counts_by_class_melt = melt(counts_by_class_wide[,list(Class2, Accuracy, Sens, Spec, PPV)], id.var = "Class2")
counts_by_class_melt[Class2=="Amino acid metabolites", Class2:="Amino acid\nmetabolites"]


counts_by_class_melt[variable=="PPV", variable:="Positive predictive\nvalue (1-FDR)"]
counts_by_class_melt[,Class2:=factor(Class2, levels = c("Monosaccharides", "Carboxylic acids", "Fatty acids", "Amino acids", "Amino acid\nmetabolites", "Bases", "Vitamins", "Other"))]
met_accuracy2 = ggplot(counts_by_class_melt[!variable %in% c("Sens", "Spec")], aes(x=Class2, y = value)) + geom_bar(stat="identity", position = position_dodge(), col = "black", fill = "grey95") +geom_hline(yintercept=0, size=1)+facet_wrap(~variable, strip.position = "left", nrow = 2)+theme( legend.title = element_blank(), panel.spacing = unit(0.2, "inches"), axis.ticks.x = element_blank(), axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 10), axis.title.y = element_blank(), strip.placement = "outside", strip.background = element_blank(), axis.text.y = element_text(size=10), strip.text = element_text(size=14)) + scale_y_continuous(expand=c(0,0), limits = c(0,1)) + xlab("")# + scale_fill_manual(values = palette = "Dark2") + xlab("")  #, strip.position = "left"

counts_by_spec = spec_met_corrs[,length(unique(Metabolite)), by=list(Outcome_v3,SpeciesName)]
counts_by_spec_wide = dcast(counts_by_spec[!is.na(Outcome_v3)], SpeciesName~Outcome_v3, value.var="V1", fill = 0)
counts_by_spec_wide[,Accuracy:=(`True positive`+`True negative`)/(`True positive`+`True negative`+`False positive`+`False negative`)]
counts_by_spec_wide[,PPV:=`True positive`/(`True positive`+`False positive`)] #This is PPV
counts_by_spec_wide[,SpeciesName:=factor(SpeciesName, levels=spec_codes[,SpeciesName])]

counts_by_spec_melt = melt(counts_by_spec_wide[,list(SpeciesName, Accuracy, PPV)], id.var = "SpeciesName")
counts_by_spec_melt = merge(counts_by_spec_melt, spec_codes, by = "SpeciesName")

counts_by_spec_melt[variable=="PPV", variable:="Positive predictive\nvalue (1-FDR)"]
counts_by_spec_melt[,Code:=factor(Code, levels = rev(spec_codes[,Code]))]
spec_accuracy2 = ggplot(counts_by_spec_melt, aes(x=Code, y = value, fill = Code)) + geom_bar(stat="identity", position = position_dodge(), col = "black")+geom_hline(yintercept=0, size=1)+facet_wrap(~variable, strip.position = "left", nrow = 2)+theme( legend.title = element_blank(), panel.spacing = unit(0.2, "inches"), axis.ticks.x = element_blank(), axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), axis.title.y = element_blank(), axis.text.y = element_text(size=10),  strip.placement = "outside", strip.background = element_blank(), strip.text = element_blank()) + scale_y_continuous(expand=c(0,0), limits = c(0,1)) + xlab("") + scale_fill_manual(values = col_spec) + xlab("") + guides(fill = F)  #, strip.position = "left"

class_plots = plot_grid(met_accuracy2+ theme(plot.margin = margin(0.5, 0.1, 0.1, 0.1, "inches")), spec_accuracy2+ theme(plot.margin = margin(0.5, 0.1, 1, 0.1, "inches")), nrow = 1, labels = c("C","D"), rel_widths = c(1.2, 1), label_y = 0.985)

#, plot.margin = margin(0.2, 0.2, 1.5, 0.2, "inches")
keyplayer_fig = plot_grid(plot_grid(plot_grid(corr_barplot+ theme(plot.margin = margin(0.3, 0.4, 0.05, 0.5, "inches")), ROC_plot1 + theme(plot.margin = margin(0.2, 0.3, 0.2, 0.4, "inches")), nrow = 2, rel_heights = c(1.1, 1), labels = c("A", "B"), label_y = 0.985), class_plots, nrow = 1, rel_widths = c(1, 1.18)), met_impact_plot + coord_flip(ylim = c(0,1.05)) + theme(axis.title.x = element_text(), axis.title.y = element_blank(), plot.margin = margin(0.1, 2.5, 0.1, 0.4, "inches")) + xlim(rev(c("Secreted", "Utilized", "Cross-fed"))), nrow = 2, rel_heights = c(2.5, 1), labels = c("", "E"), label_y = 0.985)

                        #  , met_impact_plot, nrow = 1, rel_widths = c(1.1,1.1,0.8), labels = c("", "", "E")) #nrow = 1, labels = c("A", "", ""), label_y = 0.985)#, rel_ = c(1, 1, 1.7))
save_plot(keyplayer_fig, file = "FigureS_keyPlayers.png", base_width = 9, base_height = 8)


#Combine S5 and S6
class_plots = plot_grid(met_accuracy2+ theme(plot.margin = margin(0.5, 0.1, 0.1, 0.1, "inches")), spec_accuracy2+ theme(plot.margin = margin(0.5, 0.1, 1, 0.1, "inches")), nrow = 1, labels = c("E","F"), rel_widths = c(1.2, 1), label_y = 0.985)

keyplayer_fig = plot_grid(plot_grid(plot_grid(corr_barplot+ theme(plot.margin = margin(0.3, 0.4, 0.05, 0.5, "inches")), ROC_plot1 + theme(plot.margin = margin(0.2, 0.3, 0.2, 0.4, "inches")), nrow = 2, rel_heights = c(1.1, 1), labels = c("C", "D"), label_y = 0.985), class_plots, nrow = 1, rel_widths = c(1, 1.18)), met_impact_plot + coord_flip(ylim = c(0,1.05)) + theme(axis.title.x = element_text(), axis.title.y = element_blank(), plot.margin = margin(0.1, 2.5, 0.1, 0.4, "inches")) + xlim(rev(c("Secreted", "Utilized", "Cross-fed"))), nrow = 2, rel_heights = c(2.5, 1), labels = c("", "G"), label_y = 0.985)
                        #  , met_impact_plot, nrow = 1, rel_widths = c(1.1,1.1,0.8), labels = c("", "", "E")) #nrow = 1, labels = c("A", "", ""), label_y = 0.985)#, rel_ = c(1, 1, 1.7))

fig_s56 = plot_grid(fig_s5, keyplayer_fig, nrow = 2, rel_heights = c(1.4, 2))
save_plot(fig_s56, base_width = 9, base_height = 14, file = "Figure_s5_combined.png")
```

Compare with Shapley values (Figure S2)

```{r, echo=F, message=F, warning=F}
shap_iters_file = "AllCumulMetVars.txt"
mean_shap_file = "AllShapContribs.txt"

##Generated by runShapleyAnalysis function
real_shap2 = fread(mean_shap_file)
setnames(real_shap2, "medium", "compound")
shap_contribs1[,Code:=Code.x]

shap_compare = merge(shap_contribs1[,list(compound, Code, TrueVar, V1, VarShare)], real_shap, by=c("compound", "Code"))
compare_plot1 = ggplot(shap_compare[compound %in% shap_contribs[,unique(compound)]], aes(x=abs(V1), y = abs(value))) + geom_point() + scale_x_log10() + scale_y_log10() + xlab("Analytical") + ylab("Permutation-based") + theme(axis.text = element_text(size=7), axis.title = element_text(size=11))

all_shap_iters = fread(shap_iters_file)
setnames(all_shap_iters, "medium", "compound")
all_mses = data.table()

for(i in seq(1000, 15000, by=1000)){
  shap_vals = all_shap_iters[1:(78*i)][,lapply(.SD, mean), by=compound, .SDcols = paste0("Marg_", spec_codes[1:10,Code])]
  setnames(shap_vals, gsub("Marg_", "", names(shap_vals)))
  shap_vals = melt(shap_vals, variable.name = "Code")
  shap_vals = merge(shap_vals, shap_contribs1[,list(compound, Code, TrueVar, V1, VarShare)], by=c("compound", "Code"))
  sse = shap_vals[,sum((V1-value)^2), by=list(compound, TrueVar)]
  sse[,NumPerm:=i]
  all_mses = rbind(all_mses, sse)
}

tot_mse = all_mses[,sum(V1), by=NumPerm]
sse_plot = ggplot(tot_mse, aes(x=NumPerm, y = V1)) + geom_point() + geom_line() + ylab("Sum squared error") + xlim(0, 15001)+xlab("Number of Shapley permutations") + scale_y_continuous(expand = c(0,0), limits = c(0,0.002)) + theme(axis.text = element_text(size=6), axis.title = element_text(size=10))

compare_plot1 = ggplot(shap_vals[compound %in% shap_contribs[,unique(compound)]], aes(x=abs(V1), y = abs(value))) + geom_point(size=0.75) + scale_x_log10() + scale_y_log10() + xlab("Analytical") + ylab("Permutation-based") + theme(axis.text = element_text(size=6), axis.title = element_text(size=10))

shap_plot = plot_grid(compare_plot1,sse_plot, nrow = 1, labels = c("A", "B"))
save_plot(shap_plot, file = "shapleyPermuteCompare.png", base_width = 6, base_height = 2.8)

```
